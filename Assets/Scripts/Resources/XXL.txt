-- import "BoardBlock"
local XXL = XXL or {}
local BlockItem = require "BlockItem"

blockItems = {}
clickBlocks = {}
positionTable = {}
function XXL:new()
    local o = {}
    setmetatable( o, { __index = self })
    return o   
end

function XXL:Hello()
    XXL:InitPositionTable()
    for i=1,7,1 do
        blockItems[i] ={}
        for j=1,9,1 do
            local blockItem = BlockItem:new(i,j,math.random(6))
            local i = blockItem.i
            local j = blockItem.j
            local btn = blockItem.block
            blockItems[i][j] = blockItem
            btn:GetComponent(UnityEngine.UI.Button).onClick:AddListener(
                function()
                    XXL:Click(i,j)
                end
            )
        end
    end
    XXL:Show()
end

function XXL:InitPositionTable()
    local space = 126
    local shiftX = 87
    local shiftY = -142
    for i=-6,7,1 do
        positionTable[i] ={}
        for j=1,9,1 do
            positionTable[i][j]=Vector3(shiftX+(j-1)*space,shiftY-(i-1)*space,0)
        end

    end
end

function XXL:Update()
    -- Debug.Log("lengthX="..#blockItems.."lengthY="..#blockItems[1])
end

function XXL:MoveBlock(block,i,j)--移动砖块到指定位置，并更新住砖块内容坐标
    Debug.Log("砖块(i="..block.i..",j="..block.j..")移动到("..i..","..j..")上")
    block.i = i
    block.j = j
    blockItems[i][j] = block
end

function XXL:SayHello()
    Debug.Log("hello!!!!!!!!!!!!!!!!!!!!!")
end

function XXL:ExchangeBlcok(block1,block2)--交换砖块
    Debug.Log("砖块(i="..block1.i..",j="..block1.j..")与砖块(i="..block2.i..",j="..block2.j..")交换")
    local i1 = block1.i
    local j1 = block1.j
    local i2 = block2.i
    local j2 = block2.j
    XXL:MoveBlock(block1,i2,j2)
    XXL:MoveBlock(block2,i1,j1)
end

function XXL:Click(i,j)
    Debug.Log("i="..i..",j="..j..",t="..blockItems[i][j].blockType)
    if(clickBlocks.firstBlock == nil)--如果第一个元素为空
    then
        clickBlocks.firstBlock = blockItems[i][j]
    else
        if(clickBlocks.firstBlock == blockItems[i][j])--如果点击的物体与第一个存放的物体相同
        then
            clickBlocks.firstBlock = nil
        else
            if(true)--两个砖块是否相邻
            then
            clickBlocks.secondBlock = blockItems[i][j]
            LeanTween.move( clickBlocks.firstBlock.block, positionTable[clickBlocks.secondBlock.i][clickBlocks.secondBlock.j], 1)
            LeanTween.move( clickBlocks.secondBlock.block, positionTable[clickBlocks.firstBlock.i][clickBlocks.firstBlock.j], 1):setOnComplete(
                function()
                    XXL:Judge()--砖块发生移动会
                end
            )
            XXL:ExchangeBlcok(clickBlocks.firstBlock,clickBlocks.secondBlock)
            clickBlocks.firstBlock = nil
            clickBlocks.secondBlock = nil
            XXL:Show()
            -- XXL:Judge()
            -- Debug.Log("clearBlock = "..#clearBlocks)
            else
            end
        end
    end
    XXL:Show()
    -- Debug.Log("first:i="..clickBlocks.firstBlock.i..",j="..clickBlocks.firstBlock.j)
end


function XXL:Judge()
    local clearBlocks = XXL:IsOK()
    for key, value in pairs(clearBlocks) do  
        for key1, value1 in pairs(value) do
            XXL:DestroyBlock(value1)
        end
    end
    XXL:Show()
    XXL:SayHello()
    XXL:Fall()
end

function XXL:Fall()--砖块掉落
    for j=1,9,1 do
        local empty = 0
        for i=7,1,-1 do
            if(blockItems[i][j]==nil)then
                empty = empty + 1
            else
                LeanTween.move(blockItems[i][j].block,positionTable[blockItems[i][j].i+empty][blockItems[i][j].j],1)
                XXL:MoveBlock(blockItems[i][j],blockItems[i][j].i+empty,blockItems[i][j].j)
            end
        end
        for i = 1,empty,1 do
            local blockItem = BlockItem:new(1-i,j,math.random(6))
            LeanTween.move(blockItem.block,positionTable[1-i+empty][j],1)
            XXL:MoveBlock(blockItem,1-i+empty,j)
        end
    end
    XXL:Show()
end

function XXL:DestroyBlock(blockItem)
    blockItems[blockItem.i][blockItem.j] = nil
    GameObject.Destroy(blockItem.block.gameObject)
end

function XXL:IsOK()
    local clearBlocks = {}
    local OK = false
    for i=1,7,1 do--初始化清除表
        clearBlocks[i] ={}
        -- for j=1,9,1 do
        --     clearBlocks[i][j] = nil
        -- end
    end
    for i=1,7,1 do--横向检测
        for j=1,7,1 do
            -- Debug.Log("hello")
            if(blockItems[i][j].blockType==blockItems[i][j+1].blockType and 
                blockItems[i][j].blockType==blockItems[i][j+2].blockType)--成功检测到消除
            then 
                OK = true
                clearBlocks[i][j] = blockItems[i][j]
                clearBlocks[i][j+1] = blockItems[i][j+1]
                clearBlocks[i][j+2] = blockItems[i][j+2]
            end
        end
    end
    for i=1,5,1 do--纵向检测
        for j=1,9,1 do
            if(blockItems[i][j].blockType==blockItems[i+1][j].blockType and 
                blockItems[i][j].blockType==blockItems[i+2][j].blockType)--成功检测到消除
            then 
                OK = true
                clearBlocks[i][j] = blockItems[i][j]
                clearBlocks[i+1][j] = blockItems[i+1][j]
                clearBlocks[i+2][j] = blockItems[i+2][j]
            end
        end
    end
    if(OK)then
        Debug.Log("OK=true")
    else
        Debug.Log("OK=false")
    end
    if(OK==true)then
        return clearBlocks
    end
    return nil
    -- if(OK == true)
    -- then 
    --     return clearBlock
    -- else 
    --     return nil
    -- end
end

function XXL:Show()
    s = ""
    for i=1,7,1 do
        for j=1,9,1 do
            if(blockItems[i][j]==nil)then
                s = s.."(nil     ) "
            else
                s = s.."(i"..blockItems[i][j].i.."j"..blockItems[i][j].j.."t"..blockItems[i][j].blockType..") "
            end
        end
        s = s.."\n"
    end
    print(s)
end


return XXL